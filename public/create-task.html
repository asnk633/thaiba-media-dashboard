<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Create Task — Thaiba Media</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding: 28px; background:#0f1724; color:#e6eef8; }
    .card { max-width:720px; margin:0 auto; background:#0b1220; padding:20px; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,.6); }
    label { display:block; margin-top:12px; font-weight:600; color:#cfe3ff }
    input, textarea, select { width:100%; padding:8px 10px; margin-top:6px; border-radius:6px; border:1px solid #263446; background:#071226; color:#e6eef8 }
    button { margin-top:14px; padding:10px 14px; border-radius:8px; background:#06b6d4; color:#042027; border:0; cursor:pointer; font-weight:700 }
    .msg { margin-top:12px; padding:10px; border-radius:6px; background:#071a22; color:#cfe3ff; font-size:14px }
    .error { background:#6b1111; color:#fff; padding:10px; border-radius:6px; margin-top:12px; white-space:pre-wrap; }
    #google-signin { margin-top:8px; }
    .small { font-size:13px; color:#a7cfe6; margin-top:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Create Task</h2>

    <!-- Google sign-in area -->
    <div id="google-signin"></div>
    <div id="signin-status" class="small">Not signed in — please sign in to submit a task.</div>

    <form id="taskForm" style="margin-top:12px">
      <label>Task ID
        <input id="task_id" name="task_id" required placeholder="Auto-generated" readonly>
      </label>

      <label>Task Description<textarea id="description" name="description" rows="3" placeholder="Describe the task"></textarea></label>

      <label>Assigned To
        <select id="assigned_to" name="assigned_to">
          <option value="">-- choose --</option>
        </select>
      </label>

      <label>Priority
        <select name="priority" id="priority">
          <option>Urgent</option>
          <option selected>High</option>
          <option>Medium</option>
          <option>Low</option>
        </select>
      </label>

      <label>Status
        <select name="status" id="status">
          <option selected>Pending</option>
          <option>In Progress</option>
          <option>Done</option>
        </select>
      </label>

      <label>Requested By
        <select id="requested_by" name="requested_by">
          <option value="">-- choose institution --</option>
        </select>
      </label>

      <label>Deadline
        <input id="deadline" name="deadline" type="date">
      </label>

      <label>Notes<textarea id="notes" name="notes" rows="2"></textarea></label>

      <button type="submit" id="submitBtn">Create Task</button>
    </form>

    <div id="result" class="msg" style="display:none"></div>
    <div id="rawError" class="error" style="display:none;"></div>
  </div>

  <script>
    // ---------- CONFIG ----------
    // Replace this with your Google OAuth Client ID (Web application)
    const GOOGLE_OAUTH_CLIENT_ID = "YOUR_GOOGLE_OAUTH_CLIENT_ID";
    // ----------------------------

    // state
    let idToken = null;

    // render Google Sign-In button and callback to capture ID token
    function initGoogleSignIn() {
      if (!GOOGLE_OAUTH_CLIENT_ID || GOOGLE_OAUTH_CLIENT_ID === "YOUR_GOOGLE_OAUTH_CLIENT_ID") {
        document.getElementById('signin-status').textContent = 'Google client ID not configured — sign-in disabled. Replace GOOGLE_OAUTH_CLIENT_ID in the file.';
        return;
      }

      google.accounts.id.initialize({
        client_id: GOOGLE_OAUTH_CLIENT_ID,
        callback: handleCredentialResponse
      });

      google.accounts.id.renderButton(
        document.getElementById('google-signin'),
        { theme: 'outline', size: 'large' }
      );
      // optional: google.accounts.id.prompt(); // shows One Tap if desired
    }

    function handleCredentialResponse(response) {
      if (response && response.credential) {
        idToken = response.credential;
        document.getElementById('signin-status').textContent = 'Signed in — you can submit a task.';
      }
    }

    // load metadata from server: assignedTo, institutions, nextTaskId
    async function loadMetadata() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      try {
        const res = await fetch('/api/get-metadata');
        if (!res.ok) throw new Error('Failed to load metadata');
        const json = await res.json();

        // Assigned To
        const assignedSelect = document.getElementById('assigned_to');
        assignedSelect.innerHTML = '<option value="">-- choose --</option>';
        (json.assignedTo || []).forEach(name => {
          const o = document.createElement('option'); o.value = name; o.textContent = name; assignedSelect.appendChild(o);
        });

        // Institutions -> Requested By
        const reqSelect = document.getElementById('requested_by');
        reqSelect.innerHTML = '<option value="">-- choose institution --</option>';
        (json.institutions || []).forEach(name => {
          const o = document.createElement('option'); o.value = name; o.textContent = name; reqSelect.appendChild(o);
        });

        // next task id
        document.getElementById('task_id').value = json.nextTaskId || '';

        submitBtn.disabled = false;
      } catch (err) {
        const result = document.getElementById('result');
        result.style.display = 'block';
        result.textContent = 'Unable to load metadata: ' + (err.message || err);
        result.style.background = '#3a0f12';
      }
    }

    // format date from yyyy-mm-dd -> dd/mm/yyyy
    function formatDateToDDMMYYYY(isoDate) {
      if (!isoDate) return '';
      const [y,m,d] = isoDate.split('-');
      if (!y) return isoDate;
      return `${d}/${m}/${y}`;
    }

    // submit form
    document.getElementById('taskForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const submitBtn = document.getElementById('submitBtn');
      const result = document.getElementById('result');
      const rawError = document.getElementById('rawError');
      result.style.display = 'none';
      rawError.style.display = 'none';
      submitBtn.disabled = true;

      if (!idToken) {
        rawError.style.display = 'block';
        rawError.textContent = 'Please sign in with Google before creating a task.';
        submitBtn.disabled = false;
        return;
      }

      const fd = new FormData(ev.target);
      const taskObj = Object.fromEntries(fd.entries());
      if (taskObj.deadline) taskObj.deadline = formatDateToDDMMYYYY(taskObj.deadline);

      try {
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        };

        const resp = await fetch('/api/sync', {
          method: 'POST',
          headers,
          body: JSON.stringify({ task: taskObj })
        });

        const text = await resp.text();
        let json = null;
        try { json = JSON.parse(text); } catch(e){ json = null; }

        if (!resp.ok) {
          result.style.display = 'block';
          result.style.background = '#6b1111';
          result.textContent = 'Server returned an error — see details below';
          rawError.style.display = 'block';
          rawError.textContent = text;
          submitBtn.disabled = false;
          return;
        }

        result.style.display = 'block';
        result.style.background = '#052e2a';
        result.textContent = `Task created — appended_row=${json && (json.appended_row || 'unknown') || 'unknown'} (sheet: ${json && (json.sheet || 'unknown') || 'unknown'})`;
        // reload metadata (to get nextTaskId)
        await loadMetadata();
        ev.target.reset();
        document.getElementById('task_id').value = json && json.nextTaskId || document.getElementById('task_id').value;
      } catch (err) {
        rawError.style.display = 'block';
        rawError.textContent = 'Network error: ' + (err.message || err);
      } finally {
        submitBtn.disabled = false;
      }
    });

    // init on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      initGoogleSignIn();
      loadMetadata();
    });
  </script>
</body>
</html>
