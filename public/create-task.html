<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Create Task — Thaiba Media</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #071226;
      --card: #071226;
      --muted: #9fb8d6;
      --accent: #06b6d4;
      --panel: #071226;
      --input-bg: #061425;
      --text: #e6eef8;
      --card-shadow: rgba(0,0,0,.5);
    }
    html,body{height:100%;margin:0;background:#061427;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    .wrap{max-width:880px;margin:40px auto;padding:26px;}
    .card{background:linear-gradient(180deg,#061226 0%, #071427 100%);padding:28px;border-radius:12px;box-shadow:0 10px 40px var(--card-shadow);color:var(--text)}
    h1{margin:0 0 14px;font-size:32px}
    label{display:block;margin-top:16px;font-weight:600;color:#bfe3ff}
    input[type="text"], input[type="email"], input[type="date"], textarea, select {
      width:100%; padding:12px 14px; margin-top:8px; border-radius:8px;
      background:var(--input-bg); border:1px solid #213246; color:var(--text); font-size:15px;
      box-sizing:border-box;
    }
    textarea{min-height:110px; resize:vertical}
    button { background:var(--accent); color:#042027; border:0; padding:10px 16px; border-radius:10px; font-weight:700; cursor:pointer; margin-top:18px;}
    .row { display:flex; gap:18px; align-items:flex-start; }
    .col-half { flex:1; }
    .muted { color:#9fb8d6; margin-top:8px; font-size:14px; }
    .error, .ok { margin-top:14px; padding:12px; border-radius:8px; color:#fff; }
    .error { background: #7a1515; }
    .ok { background: #083a2f; }
    #gSign { display:inline-block; margin-top:8px; }
    #signedIn { margin-top:10px; color:#bfe3ff; font-weight:600; }
    .two-col { display:flex; gap:18px; }
    .two-col > * { flex:1; }
  </style>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Create Task</h1>

      <div id="authArea">
        <div id="gSign"></div>
        <div id="signedIn" aria-live="polite"></div>
        <div id="signinHelp" class="muted">Sign in with Google to create tasks (we will verify your email).</div>
        <div id="emailFallback" style="display:none; margin-top:8px;">
          <label for="requested_by_input">Your email (if you prefer not to sign in)</label>
          <input id="requested_by_input" type="email" placeholder="name@example.com" />
        </div>
      </div>

      <form id="taskForm">
        <label>Task ID
          <input id="task_id" name="task_id" required placeholder="Auto-generated" readonly>
        </label>

        <label>Task Description
          <textarea name="description" placeholder="Describe the task"></textarea>
        </label>

        <label>Assigned To
          <select id="assigned_to" name="assigned_to">
            <option value="">-- choose --</option>
          </select>
        </label>

        <div class="two-col">
          <div>
            <label>Priority
              <select id="priority" name="priority">
                <option>Urgent</option>
                <option selected>High</option>
                <option>Medium</option>
                <option>Low</option>
              </select>
            </label>
          </div>
          <div>
            <label>Status
              <select id="status" name="status">
                <option selected>Pending</option>
                <option>In Progress</option>
                <option>Blocked</option>
                <option>Completed</option>
              </select>
            </label>
          </div>
        </div>

        <label>Requested By
          <select id="requested_by_select" style="display:block; margin-top:8px;">
            <option value="">-- choose institution --</option>
          </select>
        </label>

        <label>Deadline (will be saved as DD/MM/YYYY)
          <input id="deadline" type="date" placeholder="DD/MM/YYYY" />
        </label>

        <label>Notes
          <textarea name="notes" placeholder="Optional notes"></textarea>
        </label>

        <button type="submit">Create Task</button>

        <div id="message" aria-live="polite"></div>
      </form>
    </div>
  </div>

<script>
/*
  FULL FRONTEND FILE
  The Google Client ID (inserted below) is already set.
  Client ID used (your supplied one):
  498891903814-hatabb5r7sif258vvshk3cn263ff4inj.apps.googleusercontent.com
*/

const GOOGLE_CLIENT_ID = "498891903814-hatabb5r7sif258vvshk3cn263ff4inj.apps.googleusercontent.com";

// state
let idToken = null;
let currentUser = null;

// helper: parse JWT payload (for quick display only)
function parseJwt(token){
  try {
    const b = token.split('.')[1];
    const json = atob(b.replace(/-/g,'+').replace(/_/g,'/'));
    return JSON.parse(json);
  } catch(e){ return {}; }
}

function showMessage(type, text){
  const el = document.getElementById('message');
  el.innerHTML = '';
  if(!text) return;
  const div = document.createElement('div');
  div.className = (type === 'ok') ? 'ok' : 'error';
  div.textContent = text;
  el.appendChild(div);
}

// render Google sign-in button and initialize identity
window.addEventListener('DOMContentLoaded', () => {
  if(!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID.includes('GOOGLE_OAUTH_CLIENT_ID')) {
    document.getElementById('signinHelp').textContent = 'Google client ID not configured — sign-in disabled.';
    return;
  }

  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleCredentialResponse,
    auto_select: false
  });
  google.accounts.id.renderButton(
    document.getElementById('gSign'),
    { theme: 'outline', size: 'large' }
  );
  // prompt optional:
  // google.accounts.id.prompt();
});

// when Google returns credential
function handleCredentialResponse(response) {
  if(!response || !response.credential) return;
  idToken = response.credential;
  const payload = parseJwt(idToken);
  currentUser = payload;
  document.getElementById('signedIn').textContent = "Signed in as " + (payload.name || payload.email || 'Unknown');
  // hide sign-in and fallback email
  document.getElementById('gSign').style.display = 'none';
  document.getElementById('emailFallback').style.display = 'none';
}

// populate metadata (assignedTo, institutions, nextTaskId)
async function loadMetadata(){
  try {
    const res = await fetch('/api/get-metadata');
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e) { json = null; }
    if(!res.ok) {
      showMessage('error', 'Failed to load metadata: ' + (json && json.error ? json.error : text));
      return;
    }
    if(!json) {
      showMessage('error', 'Invalid metadata response.');
      return;
    }

    // populate assignedTo
    const aSel = document.getElementById('assigned_to');
    aSel.innerHTML = '<option value="">-- choose --</option>';
    (json.assignedTo || []).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      aSel.appendChild(opt);
    });

    // populate institutions
    const rSel = document.getElementById('requested_by_select');
    rSel.innerHTML = '<option value="">-- choose institution --</option>';
    (json.institutions || []).forEach(inst => {
      const opt = document.createElement('option');
      opt.value = inst;
      opt.textContent = inst;
      rSel.appendChild(opt);
    });

    // set nextTaskId
    if(json.nextTaskId) document.getElementById('task_id').value = json.nextTaskId;
  } catch(err) {
    console.error('metadata fetch error', err);
    showMessage('error', 'Error loading metadata: ' + err.message);
  }
}

function formatDateToDDMMYYYY(isoDate) {
  if(!isoDate) return '';
  // isoDate expected like "YYYY-MM-DD"
  const parts = isoDate.split('-');
  if(parts.length !== 3) return isoDate;
  return parts[2].padStart(2,'0') + '/' + parts[1].padStart(2,'0') + '/' + parts[0];
}

// submit handler
document.getElementById('taskForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  showMessage(null, '');

  const task = {
    task_id: document.getElementById('task_id').value,
    description: document.querySelector('textarea[name="description"]').value.trim(),
    assigned_to: document.getElementById('assigned_to').value || '',
    priority: document.getElementById('priority').value || 'High',
    status: document.getElementById('status').value || 'Pending',
    requested_by: document.getElementById('requested_by_select').value || (document.getElementById('requested_by_input') ? document.getElementById('requested_by_input').value : ''),
    deadline: formatDateToDDMMYYYY(document.getElementById('deadline').value),
    notes: document.querySelector('textarea[name="notes"]').value || ''
  };

  // basic validation
  if(!task.description) {
    showMessage('error', 'Please enter a task description.');
    return;
  }
  if(!task.requested_by) {
    showMessage('error', 'Please choose or enter Requested By (institution or your email).');
    return;
  }

  let headers = { 'Content-Type': 'application/json' };
  if(idToken) headers.Authorization = 'Bearer ' + idToken;

  try {
    const res = await fetch('/api/sync', {
      method: 'POST',
      headers,
      body: JSON.stringify({ task })
    });
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e){ json = null; }

    if(!res.ok) {
      const errText = (json && json.error) ? JSON.stringify(json) : text;
      showMessage('error', 'Server returned an error: ' + errText);
      return;
    }

    // success
    showMessage('ok', 'Task created successfully.');
    // refresh nextTaskId from server metadata (or increment locally)
    await loadMetadata();
    // reset form fields except task_id
    document.querySelector('textarea[name="description"]').value = '';
    document.getElementById('assigned_to').value = '';
    document.getElementById('priority').value = 'High';
    document.getElementById('status').value = 'Pending';
    document.getElementById('requested_by_select').value = '';
    document.getElementById('deadline').value = '';
    document.querySelector('textarea[name="notes"]').value = '';
  } catch(err) {
    console.error('submit error', err);
    showMessage('error', 'Network or server error: ' + err.message);
  }
});

// initialize
loadMetadata();
</script>
</body>
</html>
