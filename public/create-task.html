<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Create Task — Thaiba Media</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding: 28px; background:#0f1724; color:#e6eef8; }
    .card { max-width:720px; margin:0 auto; background:#0b1220; padding:20px; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,.6); }
    label { display:block; margin-top:12px; font-weight:600; color:#cfe3ff }
    input, textarea, select { width:100%; padding:8px 10px; margin-top:6px; border-radius:6px; border:1px solid #263446; background:#071226; color:#e6eef8 }
    button { margin-top:14px; padding:10px 14px; border-radius:8px; background:#06b6d4; color:#042027; border:0; cursor:pointer; font-weight:700 }
    .msg { margin-top:12px; padding:10px; border-radius:6px; background:#071a22; color:#cfe3ff; font-size:14px }
    .error { background:#6b1111; color:#fff; padding:10px; border-radius:6px; margin-top:12px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Create Task</h2>
    <form id="taskForm">
      <label>Task ID
        <input id="task_id" name="task_id" required placeholder="Auto-generated" readonly>
      </label>

      <label>Task Description<textarea name="description" rows="3" placeholder="Describe the task"></textarea></label>

      <label>Assigned To
        <select id="assigned_to" name="assigned_to">
          <option value="">-- choose --</option>
        </select>
      </label>

      <label>Priority
        <select name="priority" id="priority">
          <option>Urgent</option>
          <option selected>High</option>
          <option>Medium</option>
          <option>Low</option>
        </select>
      </label>

      <label>Status
        <select name="status" id="status">
          <option selected>Pending</option>
          <option>In Progress</option>
          <option>Done</option>
        </select>
      </label>

      <label>Requested By
        <select id="requested_by" name="requested_by">
          <option value="">-- choose institution --</option>
        </select>
      </label>

      <label>Deadline
        <input id="deadline" name="deadline" type="date">
      </label>

      <label>Notes<textarea name="notes" rows="2"></textarea></label>

      <button type="submit" id="submitBtn">Create Task</button>
    </form>

    <div id="result" class="msg" style="display:none"></div>
    <div id="rawError" class="error" style="display:none; white-space:pre-wrap;"></div>
  </div>

  <script>
    const form = document.getElementById('taskForm');
    const result = document.getElementById('result');
    const rawError = document.getElementById('rawError');
    const assignedSelect = document.getElementById('assigned_to');
    const requestedSelect = document.getElementById('requested_by');
    const taskIdInput = document.getElementById('task_id');
    const submitBtn = document.getElementById('submitBtn');

    async function loadMetadata() {
      submitBtn.disabled = true;
      try {
        const res = await fetch('/api/get-metadata');
        if (!res.ok) throw new Error('Failed to load metadata');
        const json = await res.json();

        const assigned = json.assignedTo || [];
        assignedSelect.innerHTML = '<option value=\"\">-- choose --</option>';
        assigned.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          assignedSelect.appendChild(opt);
        });

        const inst = json.institutions || [];
        requestedSelect.innerHTML = '<option value=\"\">-- choose institution --</option>';
        inst.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          requestedSelect.appendChild(opt);
        });

        taskIdInput.value = json.nextTaskId || '';
        submitBtn.disabled = false;
      } catch (err) {
        result.style.display = 'block';
        result.textContent = 'Unable to load metadata: ' + (err.message || err);
        result.style.background = '#3a0f12';
      }
    }

    function formatDateToDDMMYYYY(isoDate) {
      if (!isoDate) return '';
      const [y,m,d] = isoDate.split('-');
      if (!y || !m || !d) return isoDate;
      return `${d}/${m}/${y}`;
    }

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      result.style.display = 'none';
      rawError.style.display = 'none';
      submitBtn.disabled = true;

      const data = new FormData(form);
      const task = Object.fromEntries(data.entries());

      if (task.deadline) task.deadline = formatDateToDDMMYYYY(task.deadline);

      try {
        const headers = { 'Content-Type': 'application/json' };
        const resp = await fetch('/api/sync', {
          method: 'POST',
          headers,
          body: JSON.stringify({ task })
        });

        // read raw response text to avoid JSON parse errors for HTML/error pages
        const text = await resp.text();
        let json = null;
        try { json = JSON.parse(text); } catch(e) { json = null; }

        if (!resp.ok) {
          // show a friendly message and the raw server text for debugging
          result.style.display = 'block';
          result.style.background = '#6b1111';
          result.textContent = 'Server returned an error — see details below';
          rawError.style.display = 'block';
          rawError.textContent = text;
          submitBtn.disabled = false;
          return;
        }

        // success
        result.style.display = 'block';
        result.style.background = '#052e2a';
        result.textContent = `Task created — appended_row=${json && (json.appended_row || 'unknown') || 'unknown'} (sheet: ${json && (json.sheet || 'unknown') || 'unknown'})`;
        await loadMetadata();
        form.reset();
        taskIdInput.value = json && json.nextTaskId || taskIdInput.value;
      } catch (err) {
        rawError.style.display = 'block';
        rawError.textContent = 'Network error: ' + (err.message || err);
      } finally {
        submitBtn.disabled = false;
      }
    });

    loadMetadata();
  </script>
</body>
</html>
