<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Create Task — Thaiba Media</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding: 28px; background:#0f1724; color:#e6eef8; }
    .card { max-width:720px; margin:0 auto; background:#0b1220; padding:20px; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,.6); }
    label { display:block; margin-top:12px; font-weight:600; color:#cfe3ff }
    input, textarea, select { width:100%; padding:8px 10px; margin-top:6px; border-radius:6px; border:1px solid #263446; background:#071226; color:#e6eef8 }
    button { margin-top:14px; padding:10px 14px; border-radius:8px; background:#06b6d4; color:#042027; border:0; cursor:pointer; font-weight:700 }
    .msg { margin-top:12px; padding:10px; border-radius:6px; background:#071a22; color:#cfe3ff; font-size:14px }
    #userBanner { margin-bottom:15px; padding:10px; border-radius:6px; background:#132030; color:#aef; font-size:14px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Create Task</h2>
    <div id="userBanner">Not signed in</div>

    <form id="taskForm">
      <label>Task ID
        <input id="task_id" name="task_id" required placeholder="Auto-generated" readonly>
      </label>

      <label>Task Description<textarea name="description" rows="3" placeholder="Describe the task"></textarea></label>

      <label>Assigned To
        <select id="assigned_to" name="assigned_to">
          <option value="">-- choose --</option>
        </select>
      </label>

      <label>Priority
        <select name="priority" id="priority">
          <option>Urgent</option>
          <option selected>High</option>
          <option>Medium</option>
          <option>Low</option>
        </select>
      </label>

      <label>Status
        <select name="status" id="status">
          <option selected>Pending</option>
          <option>In Progress</option>
          <option>Completed</option>
        </select>
      </label>

      <label>Requested By
        <select id="requested_by" name="requested_by">
          <option value="">-- choose institution --</option>
        </select>
      </label>

      <label>Deadline
        <input type="date" id="deadline" name="deadline" placeholder="DD/MM/YYYY">
      </label>

      <label>Notes<textarea name="notes" rows="2" placeholder="Any extra notes"></textarea></label>

      <button type="submit">Create Task</button>
      <div class="msg" id="msgBox"></div>
    </form>
  </div>

  <script>
    const GOOGLE_OAUTH_CLIENT_ID = "498891903814-hatabb5r7sif258vvshk3cn263ff4inj.apps.googleusercontent.com";
    let idToken = null;
    let userEmail = null;

    // Google Sign-In
    window.onload = function () {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse
      });
      google.accounts.id.renderButton(document.getElementById("userBanner"), {
        theme: "outline", size: "small", text: "signin_with", shape: "pill"
      });
    };

    async function handleCredentialResponse(response) {
      idToken = response.credential;
      const payload = parseJwt(idToken);
      userEmail = payload.email;
      document.getElementById("userBanner").innerText = "Signed in as: " + userEmail;
    }

    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        return JSON.parse(decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join('')));
      } catch (e) {
        return {};
      }
    }

    // Load metadata (next TaskID, assignedTo, institutions)
    async function loadMetadata() {
      const res = await fetch('/api/get-metadata');
      const meta = await res.json();
      document.getElementById("task_id").value = meta.nextTaskId || "T000";

      let selAssigned = document.getElementById("assigned_to");
      (meta.assignedTo || []).forEach(x=>{
        let opt = document.createElement("option");
        opt.value = x; opt.textContent = x;
        selAssigned.appendChild(opt);
      });

      let selInst = document.getElementById("requested_by");
      (meta.institutions || []).forEach(x=>{
        let opt = document.createElement("option");
        opt.value = x; opt.textContent = x;
        selInst.appendChild(opt);
      });
    }
    loadMetadata();

    // Handle form submit
    document.getElementById("taskForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msgBox = document.getElementById("msgBox");
      msgBox.innerText = "Submitting...";

      if (!idToken) {
        msgBox.innerText = "Please sign in with Google first.";
        return;
      }

      const data = Object.fromEntries(new FormData(e.target).entries());
      const res = await fetch('/api/sync', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        },
        body: JSON.stringify({ task: data })
      });

      let json = null;
      try { json = await res.json(); } catch(e){ json = {error:"Invalid server response"}; }

      if (!res.ok) {
        msgBox.innerText = "Error: " + (json.error || res.statusText);
      } else {
        msgBox.innerText = "Task created ✅ Row " + json.appended_row;
        e.target.reset();
        loadMetadata();
      }
    });
  </script>
</body>
</html>
