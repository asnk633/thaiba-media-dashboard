<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Welcome — Thaiba Media Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --panel-bg: rgba(6,10,14,0.86);
      --muted: rgba(255,255,255,0.78);
      --accent-start: #00c2d8;
      --accent-end: #00a2cf;
      --glass: rgba(255,255,255,0.04);
      --radius: 14px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #fff;
    }
    html,body{height:100%;margin:0}
    body{
      background: #0b0f12 url('/static/background-image.webp') center/cover no-repeat fixed;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:48px 20px;
    }

    /* dim the background slightly and keep centered panel */
    .backdrop {
      position:fixed;inset:0;
      background:linear-gradient(to bottom, rgba(2,6,10,0.45), rgba(2,6,10,0.65));
      z-index:0;
    }

    .welcome-panel {
      position:relative;
      z-index:2;
      width:100%;
      max-width:980px;
      background:var(--panel-bg);
      border-radius:var(--radius);
      padding:32px 36px;
      box-shadow: 0 40px 80px rgba(2,6,23,0.6);
      display:flex;
      gap:28px;
      align-items:flex-start;
      color:white;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.03);
    }

    /* left column (brand + intro) */
    .left {
      flex:1;
      min-width:360px;
    }
    .brand-row{display:flex;align-items:center;gap:14px;margin-bottom:10px}
    .brand-logo{
      width:72px;
      height:72px;
      object-fit:contain;
      display:inline-block;
      border-radius:10px;
      background:transparent;
    }
    .brand-text {line-height:1}
    .brand-title{font-weight:700;font-size:18px;margin:0}
    .brand-sub{font-size:13px;color:var(--muted);margin-top:6px}

    h1{margin:6px 0 12px;font-size:32px;line-height:1.05}
    p.lead{margin:0;color:var(--muted);max-width:640px}

    .right {
      width:360px;
      min-width:260px;
      align-self:center;
    }
    .form-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);
    }
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="email"]{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
      color:#fff;
      box-sizing:border-box;
      outline:none;
      font-size:14px;
    }
    input::placeholder { color: rgba(255,255,255,0.35) }

    .actions{display:flex;gap:12px;margin-top:12px;align-items:center}
    .btn {
      padding:10px 18px;border-radius:8px;border:0;cursor:pointer;font-weight:700;
      box-shadow: 0 8px 20px rgba(2,6,23,0.4);
    }
    .btn-primary{
      background: linear-gradient(180deg, var(--accent-start), var(--accent-end));
      color:#042026;
    }
    .btn-ghost {
      background: transparent;
      color: #fff;
      border:1px solid rgba(255,255,255,0.12);
      font-weight:600;
    }

    .small-muted{font-size:13px;color:var(--muted);margin-top:14px}

    footer{width:100%;text-align:center;color:rgba(255,255,255,0.5);font-size:13px;margin-top:22px}

    /* responsive */
    @media (max-width:900px){
      .welcome-panel{flex-direction:column;max-width:760px;padding:20px}
      .right{width:100%}
      .left{min-width:unset}
    }
  </style>
</head>
<body>
  <div class="backdrop" aria-hidden="true"></div>

  <main class="welcome-panel" role="main" aria-labelledby="welcome-heading">
    <section class="left" aria-label="Intro">
      <div class="brand-row">
        <!-- Square transparent logo - replace file at /public/static/logo.png -->
        <img src="/static/logo.png" alt="Thaiba Garden logo" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-title">Thaiba Media Department</div>
          <div class="brand-sub">Thaiba Garden Group of Institutions</div>
        </div>
      </div>

      <h1 id="welcome-heading">Welcome to Thaiba Media Dashboard</h1>
      <p class="lead">Sign in once with your name and email. You'll be redirected to the view appropriate for your role (Admin / Team member / Institution requester). Close this window after successful sign-in if needed.</p>

      <p class="small-muted">We keep the UI stable — once you confirm this view it won't be changed unexpectedly.</p>
    </section>

    <aside class="right" aria-label="Sign in">
      <div class="form-card" role="form" aria-labelledby="form-title">
        <div id="form-title" style="font-weight:700;margin-bottom:8px">Sign in</div>

        <label for="fullname">Full name</label>
        <input id="fullname" type="text" placeholder="Your full name" autocomplete="name" />

        <label for="email" style="margin-top:10px">Email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />

        <div class="actions">
          <button id="continueBtn" class="btn btn-primary">Continue</button>
          <button id="guestBtn" class="btn btn-ghost">Guest (request only)</button>
        </div>

        <div id="status" style="margin-top:10px;color:rgba(255,255,255,0.7);font-size:13px"></div>

        <div class="small-muted" style="margin-top:12px">Signing in saves your name & email to this browser so we can show the right dashboard next time.</div>
      </div>

      <footer aria-hidden="true">© Thaiba Garden Group of Institutions</footer>
    </aside>
  </main>

  <script>
    const continueBtn = document.getElementById('continueBtn');
    const guestBtn = document.getElementById('guestBtn');
    const fullnameEl = document.getElementById('fullname');
    const emailEl = document.getElementById('email');
    const status = document.getElementById('status');

    function showStatus(msg, isError=false){
      status.textContent = msg;
      status.style.color = isError ? '#ffb3b3' : 'rgba(255,255,255,0.85)';
    }

    // Try to detect role by calling /api/roles (server-side)
    async function detectRoleByEmail(email){
      try {
        const r = await fetch('/api/roles', { cache: 'no-store' });
        if(!r.ok) throw new Error('roles API not available');
        const js = await r.json();
        const admins = (js.admins||[]).map(s=>String(s).toLowerCase());
        const team = (js.team||js.members||js.users||[]).map(s=>String(s).toLowerCase());
        const e = email.toLowerCase();
        if(admins.includes(e)) return 'admin';
        if(team.includes(e)) return 'team';
        return 'institution';
      } catch (err){
        // fallback heuristic:
        const e = email.toLowerCase();
        if(e === 'media@thaibagarden.com') return 'admin';
        if(e.endsWith('@thaibagarden.com')) return 'team';
        return 'institution';
      }
    }

    function saveProfile(name,email,role){
      try {
        localStorage.setItem('thaiba_profile', JSON.stringify({name,email,role,ts:Date.now()}));
      } catch(e){}
    }

    function redirectForRole(role){
      if(role === 'admin') location.href = '/admin.html';
      else if(role === 'team') location.href = '/team.html';
      else location.href = '/create-task.html';
    }

    continueBtn.addEventListener('click', async ()=>{
      const name = fullnameEl.value.trim();
      const email = emailEl.value.trim();
      if(!name) return showStatus('Please enter your full name', true);
      if(!email || !email.includes('@')) return showStatus('Please enter a valid email', true);

      showStatus('Detecting role — please wait…');
      continueBtn.disabled = true;
      guestBtn.disabled = true;

      try {
        const role = await detectRoleByEmail(email);
        saveProfile(name,email,role);
        showStatus('Signed in as ' + role + '. Redirecting…');
        setTimeout(()=> redirectForRole(role), 400);
      } catch (err){
        console.error(err);
        showStatus('Failed to detect role — continuing as guest', true);
        saveProfile(name,email,'institution');
        setTimeout(()=> redirectForRole('institution'), 800);
      } finally {
        continueBtn.disabled = false;
        guestBtn.disabled = false;
      }
    });

    // special: guest (request only)
    guestBtn.addEventListener('click', ()=>{
      const name = fullnameEl.value.trim() || 'Guest';
      const email = emailEl.value.trim() || '';
      saveProfile(name,email,'institution');
      redirectForRole('institution');
    });

    // if a profile already exists, forward them to their view immediately
    (function autoRedirectIfKnown(){
      try {
        const v = localStorage.getItem('thaiba_profile');
        if(!v) return;
        const p = JSON.parse(v);
        if(p && p.role) {
          // small delay so user sees where we landed
          setTimeout(()=> redirectForRole(p.role), 200);
        }
      } catch(e){}
    })();
  </script>
</body>
</html>
